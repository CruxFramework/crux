<?xml version="1.0" encoding="UTF-8"?>

<project name="Archetypes-maven" default="init" basedir="." xmlns:artifact="antlib:org.apache.maven.artifact.ant">
    <!-- Configs -->
    <property name="dist" location="dist" />
	<property name="version" value="5.0.4" />

    <!-- define Crux dist folder -->
    <property name="dist_crux" location="dist" />
    
	<!-- define pom path -->
	<property name="poms" location="poms" />

	<!-- define Maven coordinates -->
	<property name="groupId" value="org.cruxframework" />
	
	<property name="artifactId_crux-archetypes" value="crux-archetypes" />
	<property name="artifactId_crux-base-archetype" value="crux-base-archetype" />
	<property name="artifactId_crux-module-app" value="crux-module-app" />
	<property name="artifactId_crux-module-container-app" value="crux-module-container-app" />
	
	<!-- define artifacts' name, which follows the convention of Maven -->
    <property name="maven-jar_crux-archetypes" value="${dist}/${artifactId_crux-archetypes}-${version}.pom" />
    <property name="maven-javadoc-jar_crux-archetypes" value="${dist}/${artifactId_crux-archetypes}-${version}-javadoc.pom" />
    <property name="maven-sources-jar_crux-archetypes" value="${dist}/${artifactId_crux-archetypes}-${version}-sources.pom" />
	
    <property name="maven-jar_crux-base-archetype" value="${dist}/${artifactId_crux-base-archetype}-${version}.pom" />
    <property name="maven-javadoc-jar_crux-base-archetype" value="${dist}/${artifactId_crux-base-archetype}-${version}-javadoc.pom" />
    <property name="maven-sources-jar_crux-base-archetype" value="${dist}/${artifactId_crux-base-archetype}-${version}-sources.pom" />
	
	<property name="maven-jar_crux-module-app" value="${dist}/${artifactId_crux-module-app}-${version}.jar" />
	<property name="maven-javadoc-jar_crux-module-app" value="${dist}/${artifactId_crux-module-app}-${version}-javadoc.jar" />
	<property name="maven-sources-jar_crux-module-app" value="${dist}/${artifactId_crux-module-app}-${version}-sources.jar" />

    <property name="maven-jar_crux-module-container-app" value="${dist}/${artifactId_crux-module-container-app}-${version}.jar" />
    <property name="maven-javadoc-jar_crux-module-container-app" value="${dist}/${artifactId_crux-module-container-app}-${version}-javadoc.jar" />
    <property name="maven-sources-jar_crux-module-container-app" value="${dist}/${artifactId_crux-module-container-app}-${version}-sources.jar" />

	<!-- defined maven snapshots and staging repository id and url -->
	<property name="maven-snapshots-repository-id" value="sonatype-nexus-snapshots" />
	<property name="maven-snapshots-repository-url" value="https://oss.sonatype.org/content/repositories/snapshots" />
	<property name="maven-staging-repository-id" value="sonatype-nexus-staging" />
	<property name="maven-staging-repository-url" value="https://oss.sonatype.org/service/local/staging/deploy/maven2" />

	<path id="maven-ant-tasks.classpath" path="lib/maven-ant-tasks-2.1.3.jar" />
	<typedef resource="org/apache/maven/artifact/ant/antlib.xml"
	           uri="antlib:org.apache.maven.artifact.ant"
	           classpathref="maven-ant-tasks.classpath" />
	
	<target name="init">
	</target>

	<macrodef name="copyPomStage">
        <attribute name="archetypepath"/>
        <sequential>
            <copy todir="${dist}">
                <fileset dir="@{archetypepath}" />
                <globmapper from="*.xml" to="*.pom"/>
            </copy>
            

        </sequential>
    </macrodef>
	
    <macrodef name="copyFilesStage">
    	<attribute name="archetypepath"/>
        <sequential>
            <copy todir="${dist}">
                <fileset dir="@{archetypepath}" />
                <globmapper from="*.jar" to="*.jar"/>
            </copy>
            
            <copy todir="${dist}">
                <fileset dir="@{archetypepath}" />
                <globmapper from="*.jar" to="*-javadoc.jar"/>
            </copy>

            <copy todir="${dist}">
                <fileset dir="@{archetypepath}" />
                <globmapper from="*.jar" to="*-sources.jar"/>
            </copy>
        </sequential>
    </macrodef>
	
    <target name="copy-dist">
    	<delete dir="${dist}" failonerror="no" />
    	<mkdir dir="${dist}" />
        <copy todir="${dist}">
            <fileset dir="${dist_crux}" />
        	<globmapper from="*.jar" to="*-${version}.jar"/>
        </copy>
    </target>

	<target name="deploy" depends="copy-dist" description="deploy snapshot version to Maven snapshot repository">
		<artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
            <arg value="-Durl=${maven-snapshots-repository-url}" />
            <arg value="-DrepositoryId=${maven-snapshots-repository-id}" />
            <arg value="-DpomFile=${poms}/pom_crux-archetypes.xml" />
            <arg value="-Dfile=${maven-jar_crux-archetypes}" />
        </artifact:mvn>
        <artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
            <arg value="-Durl=${maven-snapshots-repository-url}" />
            <arg value="-DrepositoryId=${maven-snapshots-repository-id}" />
            <arg value="-DpomFile=${poms}/pom_crux-base-archetype.xml" />
            <arg value="-Dfile=${maven-jar_crux-base-archetype}" />
        </artifact:mvn>
		<artifact:mvn>
			<arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
			<arg value="-Durl=${maven-snapshots-repository-url}" />
			<arg value="-DrepositoryId=${maven-snapshots-repository-id}" />
			<arg value="-DpomFile=${poms}/pom_crux-module-app.xml" />
			<arg value="-Dfile=${maven-jar_crux-module-app}" />
		</artifact:mvn>
		<artifact:mvn>
            <arg value="org.apache.maven.plugins:maven-deploy-plugin:2.6:deploy-file" />
            <arg value="-Durl=${maven-snapshots-repository-url}" />
            <arg value="-DrepositoryId=${maven-snapshots-repository-id}" />
            <arg value="-DpomFile=${poms}/pom_crux-module-container-app.xml" />
            <arg value="-Dfile=${maven-jar_crux-module-container-app}" />
        </artifact:mvn>
	</target>

	<!-- before this, update project version (both build.xml and pom.xml) from SNAPSHOT to RELEASE -->
	<target name="stage" description="deploy release version to Maven staging repository">
		<!-- get and prepare jars to send -->
		<delete dir="${dist}" failonerror="no" />
		<mkdir dir="${dist}" />
		<copyPomStage archetypepath="../../../${artifactId_crux-archetypes}"/>
		

	</target>

</project>